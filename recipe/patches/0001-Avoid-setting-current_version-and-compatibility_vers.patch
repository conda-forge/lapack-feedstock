From b3cf6f21f56af861a23cfdcca92e0307a9ae995a Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Thu, 22 Nov 2018 19:39:51 -0600
Subject: [PATCH 1/2] Avoid setting current_version and compatibility_version
 on OSX

To facilitate the switching of implementations, avoid these appearing
in libblas.dylib etc., so that downstream consumers don't record them.
---
 BLAS/SRC/CMakeLists.txt       |  9 +++++++--
 CBLAS/src/CMakeLists.txt      |  9 +++++++--
 LAPACKE/CMakeLists.txt        |  9 +++++++--
 SRC/CMakeLists.txt            | 12 +++++++-----
 TESTING/MATGEN/CMakeLists.txt | 12 +++++++-----
 5 files changed, 35 insertions(+), 16 deletions(-)

diff --git a/BLAS/SRC/CMakeLists.txt b/BLAS/SRC/CMakeLists.txt
index b9e6f7c..0af0e9b 100644
--- a/BLAS/SRC/CMakeLists.txt
+++ b/BLAS/SRC/CMakeLists.txt
@@ -150,10 +150,15 @@ add_library(${BLASLIB}
 
 set_target_properties(
   ${BLASLIB} PROPERTIES
-  VERSION ${LAPACK_VERSION}
-  SOVERSION ${LAPACK_MAJOR_VERSION}
   POSITION_INDEPENDENT_CODE ON
   )
+if (NOT APPLE)
+  set_target_properties(
+    ${BLASLIB} PROPERTIES
+    VERSION ${LAPACK_VERSION}
+    SOVERSION ${LAPACK_MAJOR_VERSION}
+  )
+endif()
 lapack_install_library(${BLASLIB})
 
 if( TEST_FORTRAN_COMPILER )
diff --git a/CBLAS/src/CMakeLists.txt b/CBLAS/src/CMakeLists.txt
index 8dcb2f2..0126d2b 100644
--- a/CBLAS/src/CMakeLists.txt
+++ b/CBLAS/src/CMakeLists.txt
@@ -171,10 +171,15 @@ add_library(${CBLASLIB}
 set_target_properties(
   ${CBLASLIB} PROPERTIES
   LINKER_LANGUAGE C
-  VERSION ${LAPACK_VERSION}
-  SOVERSION ${LAPACK_MAJOR_VERSION}
   POSITION_INDEPENDENT_CODE ON
   )
+if (NOT APPLE)
+  set_target_properties(
+    ${CBLASLIB} PROPERTIES
+    VERSION ${LAPACK_VERSION}
+    SOVERSION ${LAPACK_MAJOR_VERSION}
+  )
+endif()
 
 target_include_directories(${CBLASLIB} PUBLIC
   $<INSTALL_INTERFACE:include>
diff --git a/LAPACKE/CMakeLists.txt b/LAPACKE/CMakeLists.txt
index 7923f47..e5a671a 100644
--- a/LAPACKE/CMakeLists.txt
+++ b/LAPACKE/CMakeLists.txt
@@ -93,10 +93,15 @@ add_library(${LAPACKELIB} $<TARGET_OBJECTS:${LAPACKELIB}_obj>
 set_target_properties(
   ${LAPACKELIB} PROPERTIES
   LINKER_LANGUAGE C
-  VERSION ${LAPACK_VERSION}
-  SOVERSION ${LAPACK_MAJOR_VERSION}
   POSITION_INDEPENDENT_CODE ON
   )
+if (NOT APPLE)
+  set_target_properties(
+    ${LAPACKELIB} PROPERTIES
+    VERSION ${LAPACK_VERSION}
+    SOVERSION ${LAPACK_MAJOR_VERSION}
+  )
+endif()
 target_include_directories(${LAPACKELIB} PUBLIC
     $<BUILD_INTERFACE:${LAPACK_BINARY_DIR}/include>
   $<INSTALL_INTERFACE:include>
diff --git a/SRC/CMakeLists.txt b/SRC/CMakeLists.txt
index be426ce..440c3ab 100644
--- a/SRC/CMakeLists.txt
+++ b/SRC/CMakeLists.txt
@@ -569,11 +569,13 @@ add_library(${LAPACKLIB}
   $<TARGET_OBJECTS:mod_files>
   $<TARGET_OBJECTS:${LAPACKLIB}_obj>
   $<$<BOOL:${BUILD_INDEX64_EXT_API}>: $<TARGET_OBJECTS:${LAPACKLIB}_64_obj>>)
-set_target_properties(
-  ${LAPACKLIB} PROPERTIES
-  VERSION ${LAPACK_VERSION}
-  SOVERSION ${LAPACK_MAJOR_VERSION}
-  )
+if (NOT APPLE)
+  set_target_properties(
+    ${LAPACKLIB} PROPERTIES
+    VERSION ${LAPACK_VERSION}
+    SOVERSION ${LAPACK_MAJOR_VERSION}
+    )
+endif()
 
 if( TEST_FORTRAN_COMPILER )
   add_dependencies( ${LAPACKLIB} run_test_zcomplexabs run_test_zcomplexdiv run_test_zcomplexmult run_test_zminMax )
diff --git a/TESTING/MATGEN/CMakeLists.txt b/TESTING/MATGEN/CMakeLists.txt
index 02e05a8..e42759f 100644
--- a/TESTING/MATGEN/CMakeLists.txt
+++ b/TESTING/MATGEN/CMakeLists.txt
@@ -87,11 +87,13 @@ add_library(${TMGLIB}
         $<TARGET_OBJECTS:${TMGLIB}_obj>
         $<$<BOOL:${BUILD_INDEX64_EXT_API}>: $<TARGET_OBJECTS:${TMGLIB}_64_obj>>)
 
-set_target_properties(
-  ${TMGLIB} PROPERTIES
-  VERSION ${LAPACK_VERSION}
-  SOVERSION ${LAPACK_MAJOR_VERSION}
-)
+if (NOT APPLE)
+  set_target_properties(
+    ${TMGLIB} PROPERTIES
+    VERSION ${LAPACK_VERSION}
+    SOVERSION ${LAPACK_MAJOR_VERSION}
+  )
+endif()
 
 target_link_libraries(${TMGLIB} ${LAPACK_LIBRARIES} ${BLAS_LIBRARIES})
 lapack_install_library(${TMGLIB})
-- 
2.45.2

